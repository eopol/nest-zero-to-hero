{"version":3,"sources":["../../../src/framework/adapters/fastify.adapter.ts"],"sourcesContent":["import FastifyCookie from '@fastify/cookie';\nimport FastifyMultipart from '@fastify/multipart';\nimport { FastifyAdapter } from '@nestjs/platform-fastify';\n\nconst fastifyApp: FastifyAdapter = new FastifyAdapter({\n  trustProxy: true,\n  logger: false,\n});\n\nfastifyApp.register(FastifyMultipart, {\n  limits: {\n    fields: 10, // Max number of non-file fields\n    fileSize: 1024 * 1024 * 20, // limit size 20M\n    files: 10, // Max number of file fields\n  },\n});\n\nfastifyApp.register(FastifyCookie, {\n  secret: 'backend-cookie-secret', // 这个 secret 不太重要，不存鉴权相关，无关紧要\n});\n\nfastifyApp.getInstance().addHook('onRequest', (request, reply, done) => {\n  const {\n    url,\n    headers: { origin },\n  } = request;\n  if (!origin) request.headers.origin = request.headers.host;\n\n  // set undefined origin\n  (reply as any).setHeader = function (key: string, value: any) {\n    return this.raw.setHeader(key, value);\n  };\n  (reply as any).end = function () {\n    this.raw.end();\n  };\n  (request as any).res = reply;\n\n  // forbidden php\n  if (url.endsWith('.php')) {\n    reply.raw.statusMessage =\n      'Eh. PHP is not support on this machine. Yep, I also think PHP is bestest programming language. But for me it is beyond my reach.';\n    return reply.code(418).send();\n  }\n\n  // skip favicon request\n  if (url.match(/favicon.ico$/) || url.match(/manifest.json$/)) {\n    return reply.code(204).send();\n  }\n\n  done();\n});\n\nexport { fastifyApp };\n"],"names":["fastifyApp","FastifyAdapter","trustProxy","logger","register","FastifyMultipart","limits","fields","fileSize","files","FastifyCookie","secret","getInstance","addHook","request","reply","done","url","headers","origin","host","setHeader","key","value","raw","end","res","endsWith","statusMessage","code","send","match"],"mappings":";;;;+BAoDSA;;;eAAAA;;;+DApDiB;kEACG;iCACE;;;;;;AAE/B,MAAMA,aAA6B,IAAIC,+BAAc,CAAC;IACpDC,YAAY;IACZC,QAAQ;AACV;AAEAH,WAAWI,QAAQ,CAACC,kBAAgB,EAAE;IACpCC,QAAQ;QACNC,QAAQ;QACRC,UAAU,OAAO,OAAO;QACxBC,OAAO;IACT;AACF;AAEAT,WAAWI,QAAQ,CAACM,eAAa,EAAE;IACjCC,QAAQ;AACV;AAEAX,WAAWY,WAAW,GAAGC,OAAO,CAAC,aAAa,CAACC,SAASC,OAAOC;IAC7D,MAAM,EACJC,GAAG,EACHC,SAAS,EAAEC,MAAM,EAAE,EACpB,GAAGL;IACJ,IAAI,CAACK,QAAQL,QAAQI,OAAO,CAACC,MAAM,GAAGL,QAAQI,OAAO,CAACE,IAAI;IAE1D,uBAAuB;IACtBL,MAAcM,SAAS,GAAG,SAAUC,GAAW,EAAEC,KAAU;QAC1D,OAAO,IAAI,CAACC,GAAG,CAACH,SAAS,CAACC,KAAKC;IACjC;IACCR,MAAcU,GAAG,GAAG;QACnB,IAAI,CAACD,GAAG,CAACC,GAAG;IACd;IACCX,QAAgBY,GAAG,GAAGX;IAEvB,gBAAgB;IAChB,IAAIE,IAAIU,QAAQ,CAAC,SAAS;QACxBZ,MAAMS,GAAG,CAACI,aAAa,GACrB;QACF,OAAOb,MAAMc,IAAI,CAAC,KAAKC,IAAI;IAC7B;IAEA,uBAAuB;IACvB,IAAIb,IAAIc,KAAK,CAAC,mBAAmBd,IAAIc,KAAK,CAAC,mBAAmB;QAC5D,OAAOhB,MAAMc,IAAI,CAAC,KAAKC,IAAI;IAC7B;IAEAd;AACF"}